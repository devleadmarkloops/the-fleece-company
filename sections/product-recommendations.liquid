{%- style -%}
  #shopify-section-{{ section.id }} {
    --section-padding-top: {{ section.settings.padding_top }}px;
    --section-padding-bottom: {{ section.settings.padding_bottom }}px;
    --image-position: {{ section.settings.image_position }};
    --color-highlight: {{ section.settings.colors_highlight.red }}, {{ section.settings.colors_highlight.green }}, {{ section.settings.colors_highlight.blue }};
  }

  @media screen and (max-width: 749px) {
    #shopify-section-{{ section.id }} {
      --section-padding-top: {{ section.settings.padding_top_mob }}px;
      --section-padding-bottom: {{ section.settings.padding_bottom_mob }}px;
    }
  }

  #shopify-section-{{ section.id }} .rec-header-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }
  #shopify-section-{{ section.id }} .rec-header-wrapper .title {
    margin: 0;
  }
  #shopify-section-{{ section.id }} .recommendations-nav {
    display: flex;
    gap: 8px;
  }
  #shopify-section-{{ section.id }} .rec-nav-btn {
    display: inline-flex;
    position: static;
    width: 3.5rem;
    height: 3.5rem;
    margin: 0;
    background: transparent;
    border: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
  }
  #shopify-section-{{ section.id }} .rec-nav-btn:hover {
    opacity: 0.85;
  }
  #shopify-section-{{ section.id }} .rec-nav-btn::after {
    font-size: 1.6rem;
    font-weight: bold;
    color: rgb(var(--color-foreground));
  }
  #shopify-section-{{ section.id }} .swiper-slide {
    height: auto; /* Forces the slide to match the tallest sibling */
  }

  @media screen and (max-width: 749px) {
    #shopify-section-{{ section.id }} .rec-header-wrapper {
      margin-bottom: 1.5rem;
      justify-content: center;
      text-align: center;
    }
    #shopify-section-{{ section.id }} .rec-nav-btn {
      width: 2.5rem;
      height: 2.5rem;
    }
    #shopify-section-{{ section.id }} .rec-nav-btn::after {
      font-size: 12px;
    }
  }
{%- endstyle -%}

<link rel="stylesheet" href="{{ 'component-card.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-price.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-product-grid.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'component-slider.css' | asset_url }}" media="print" onload="this.media='all'">
<link rel="stylesheet" href="{{ 'section-product-recommendations.css' | asset_url }}" media="print" onload="this.media='all'">

{%- if settings.quick_view_enabled and section.settings.enable_quick_view -%}
  <link rel="stylesheet" href="{{ 'section-main-product.css' | asset_url }}" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="{{ 'component-deferred-media.css' | asset_url }}" media="print" onload="this.media='all'">
{%- endif -%}

<product-recommendations class="product-recommendations" data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ section.settings.product_list_limit }}">
  {%- if recommendations.performed and recommendations.products_count > 0 -%}
    <div class="section--padding{% if section.settings.show_divider %} section--divider{% endif %}">
      <div class="page-width">
        
        {%- comment -%} HEADING AND NAVIGATION ARROWS {%- endcomment -%}
        <div class="title-wrapper rec-header-wrapper{% if section.settings.heading == blank %} title-wrapper--no-heading{% endif %} {{ section.settings.heading_alignment }}">
          <{{ section.settings.heading_tag }} class="title {{ section.settings.heading_size }}">
            {%- if section.settings.heading != blank -%}
              {%- render 'highlight-text', 
                hl_input: section.settings.heading, 
                hl_style: section.settings.highlight_style,
                hl_enable: section.settings.enable_highlight,
                hl_animateWrap: true -%}
            {%- endif -%}
          </{{ section.settings.heading_tag }}>
          
          <div class="recommendations-nav small-hide">
            <div class="swiper-button-prev rec-prev rec-nav-btn"></div>
            <div class="swiper-button-next rec-next rec-nav-btn"></div>
          </div>
        </div>
        
        {%- comment -%} SWIPER WRAPPER {%- endcomment -%}
        <div class="swiper recommendations-swiper">
          <div class="swiper-wrapper">
            {%- for recommendation in recommendations.products -%}
              <div class="swiper-slide">
                {% render 'card-product-v2',
                  card_product: recommendation,
                  card_collection: collection,
                  media_size: section.settings.image_ratio,
                  show_secondary_image: section.settings.show_secondary_image,
                  show_quick_buy: section.settings.show_quick_buy,
                  show_vendor: section.settings.show_vendor,
                  show_rating: section.settings.show_rating,
                  enable_quick_view: section.settings.enable_quick_view,
                  enable_color_swatches: section.settings.enable_color_swatches,
                  enable_countdown: section.settings.enable_countdown,
                  enable_image_fill: section.settings.enable_image_fill
                %}
              </div>
            {%- endfor -%}
          </div>
        </div>

      </div>
    </div>
  {%- endif -%}
</product-recommendations>
<script>
  if (!customElements.get('card-v2-variant-selector')) {
    customElements.define('card-v2-variant-selector', class extends HTMLElement {
      connectedCallback() {
        this.addEventListener('change', this.onVariantChange.bind(this));
        this.addEventListener('click', this.onClick.bind(this));
      }

      onClick(e) {
        if (e.target.matches('.card-v2-view-all-colors')) {
          e.preventDefault();
          this.querySelectorAll('.hidden-swatch').forEach(el => el.style.display = 'block');
          e.target.style.display = 'none';
        }
      }

      onVariantChange(e) {
        if (!e.target.matches('.card-v2-radio')) return;

        // 1. Update UI Styling immediately
        if (e.target.classList.contains('card-v2-radio-color')) {
           const wrapper = e.target.closest('.card-v2-swatches');
           wrapper.querySelectorAll('.card-v2-swatch').forEach(lbl => lbl.style.outline = 'none');
           e.target.closest('label').style.outline = '1px solid rgb(var(--color-foreground))';
           e.target.closest('label').style.outlineOffset = '2px';
        } else if (e.target.classList.contains('card-v2-radio-pill')) {
           const wrapper = e.target.closest('.card-v2-pills');
           wrapper.querySelectorAll('.card-v2-pill').forEach(lbl => {
             lbl.style.background = 'rgb(var(--color-background))'; lbl.style.color = 'rgb(var(--color-foreground))'; lbl.style.borderColor = '#e1e1e1';
           });
           e.target.closest('label').style.background = 'rgb(var(--color-foreground))';
           e.target.closest('label').style.color = 'rgb(var(--color-background))';
           e.target.closest('label').style.borderColor = 'rgb(var(--color-foreground))';
        }

        // 2. Fetch data & match variant
        const jsonScript = this.querySelector('.card-v2-json');
        if (!jsonScript) return;
        const variants = JSON.parse(jsonScript.innerHTML);

        const checkedRadios = Array.from(this.querySelectorAll('.card-v2-radio:checked'));
        let currentOptions = [];
        checkedRadios.forEach(radio => currentOptions[parseInt(radio.dataset.optionIndex)] = radio.value);

        const match = variants.find(v => v.options.every((opt, i) => opt === currentOptions[i]));

        // 3. Update the rest of the Card
        if (match) {
          const card = this.closest('.card-wrapper');
          if(!card) return;

          // A. Update Form ID (Crucial for Add to Cart)
          const idInput = card.querySelector('.card-v2-final-id');
          if (idInput) idInput.value = match.id;

          // B. Update Main Image
          const img = card.querySelector('.card-v2-main-image');
          if (img && match.featured_image) {
            img.src = match.featured_image;
            img.srcset = match.featured_image;
          }

          // C. Update Button State
          const btn = card.querySelector('.card-v2-add-btn');
          if (btn) {
            if (match.available) {
              btn.textContent = "{{ 'products.product.add_to_cart' | t }}";
              btn.disabled = false;
              btn.classList.remove('disabled');
            } else {
              btn.textContent = "{{ 'products.product.sold_out' | t }}";
              btn.disabled = true;
              btn.classList.add('disabled');
            }
          }

          // D. Update Exact Price Text 
          const priceRegular = card.querySelector('.price-item--regular');
          if (priceRegular) priceRegular.innerHTML = match.price; 
        }
      }
    });
  }
</script>

{% schema %}
{
  "name": "t:sections.product-recommendations.name",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "t:sections.product-recommendations.settings.paragraph.content"
    },
    {
      "type": "range",
      "id": "product_list_limit",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 4,
      "label": "t:sections.main-product.blocks.complementary_products.settings.product_list_limit.label"
    },
    {
      "type": "checkbox",
      "id": "show_divider",
      "default": false,
      "label": "t:sections.all.show_divider.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.heading.label"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "default": "You may also like",
      "label": "t:sections.all.heading.label"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "t:sections.all.heading_size.options__1.label"
        },
        {
          "value": "h1",
          "label": "t:sections.all.heading_size.options__2.label"
        },
        {
          "value": "h0",
          "label": "t:sections.all.heading_size.options__3.label"
        }
      ],
      "default": "h1",
      "label": "t:sections.all.heading_size.label"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "t:sections.all.heading_alignment.label",
      "options": [
        {
          "value": "left",
          "label": "t:sections.all.heading_alignment.options__1.label"
        },
        {
          "value": "center",
          "label": "t:sections.all.heading_alignment.options__2.label"
        },
        {
          "value": "right",
          "label": "t:sections.all.heading_alignment.options__3.label"
        }
      ],
      "default": "left"
    },
    {
      "type": "select",
      "id": "heading_tag",
      "options": [
        {
          "value": "h1",
          "label": "t:sections.all.heading_tag.options__1.label"
        },
        {
          "value": "h2",
          "label": "t:sections.all.heading_tag.options__2.label"
        },
        {
          "value": "h3",
          "label": "t:sections.all.heading_tag.options__3.label"
        },
        {
          "value": "h4",
          "label": "t:sections.all.heading_tag.options__4.label"
        },
        {
          "value": "h5",
          "label": "t:sections.all.heading_tag.options__5.label"
        },
        {
          "value": "h6",
          "label": "t:sections.all.heading_tag.options__6.label"
        },
        {
          "value": "div",
          "label": "t:sections.all.heading_tag.options__7.label"
        },
        {
          "value": "span",
          "label": "t:sections.all.heading_tag.options__8.label"
        },
        {
          "value": "p",
          "label": "t:sections.all.heading_tag.options__9.label"
        }
      ],
      "default": "h2",
      "label": "t:sections.all.heading_tag.label",
      "info": "t:sections.all.heading_tag.info"
    },
    {
      "type": "header",
      "content": "t:sections.all.mobile_layout.header.content"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "t:sections.all.mobile_layout.columns_mobile.options__1.label"
        },
        {
          "value": "2",
          "label": "t:sections.all.mobile_layout.columns_mobile.options__2.label"
        }
      ],
      "default": "2",
      "label": "t:sections.all.mobile_layout.columns_mobile.label"
    },
    {
      "type": "checkbox",
      "id": "swipe_on_mobile",
      "default": false,
      "label": "t:sections.all.mobile_layout.swipe_on_mobile.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.product_card.header.content"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:sections.all.card_image_ratio.options__1.label"
        },
        {
          "value": "square",
          "label": "t:sections.all.card_image_ratio.options__2.label"
        },
        {
          "value": "portrait",
          "label": "t:sections.all.card_image_ratio.options__3.label"
        },
        {
          "value": "landscape",
          "label": "t:sections.all.card_image_ratio.options__4.label"
        },
        {
          "value": "wide",
          "label": "t:sections.all.card_image_ratio.options__5.label"
        }
      ],
      "default": "adapt",
      "label": "t:sections.all.card_image_ratio.label"
    },
    {
      "type": "select",
      "id": "image_position",
      "options": [
        {
          "value": "20% 0",
          "label": "t:sections.all.image_position.options__1.label"
        },
        {
          "value": "top center",
          "label": "t:sections.all.image_position.options__2.label"
        },
        {
          "value": "80% 0",
          "label": "t:sections.all.image_position.options__3.label"
        },
        {
          "value": "20% 50%",
          "label": "t:sections.all.image_position.options__4.label"
        },
        {
          "value": "center center",
          "label": "t:sections.all.image_position.options__5.label"
        },
        {
          "value": "80% 50%",
          "label": "t:sections.all.image_position.options__6.label"
        },
        {
          "value": "20% 100%",
          "label": "t:sections.all.image_position.options__7.label"
        },
        {
          "value": "bottom center",
          "label": "t:sections.all.image_position.options__8.label"
        },
        {
          "value": "80% 100%",
          "label": "t:sections.all.image_position.options__9.label"
        }
      ],
      "default": "center center",
      "label": "t:sections.all.image_position.label",
      "info": "t:sections.all.image_position.info"
    },
    {
      "type": "checkbox",
      "id": "enable_image_fill",
      "default": true,
      "label": "t:sections.all.product_card.enable_image_fill.label",
      "info": "t:sections.all.product_card.enable_image_fill.info"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": false,
      "label": "t:sections.all.product_card.show_secondary_image.label"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "t:sections.all.product_card.show_vendor.label"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "t:sections.all.product_card.show_rating.label",
      "info": "t:sections.all.product_card.show_rating.info"
    },
    {
      "type": "checkbox",
      "id": "show_quick_buy",
      "default": true,
      "label": "t:sections.all.product_card.show_quick_buy.label"
    },
    {
      "type": "checkbox",
      "id": "enable_quick_view",
      "default": true,
      "label": "t:sections.all.product_card.enable_quick_view.label"
    },
    {
      "type": "checkbox",
      "id": "enable_color_swatches",
      "default": true,
      "label": "t:sections.all.product_card.enable_color_swatches.label"
    },
    {
      "type": "checkbox",
      "id": "enable_countdown",
      "default": true,
      "label": "t:sections.all.product_card.enable_countdown.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.colors.header.content"
    },
    {
      "type": "color",
      "id": "colors_highlight",
      "label": "t:sections.all.colors.colors_highlight.label",
      "default": "#ffb503"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.header.content"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "t:sections.all.padding.padding_top.unit",
      "label": "t:sections.all.padding.padding_top.label",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "t:sections.all.padding.padding_bottom.unit",
      "label": "t:sections.all.padding.padding_bottom.label",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_top_mob",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "t:sections.all.padding.padding_top.unit",
      "label": "Top padding (mobile)",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom_mob",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "t:sections.all.padding.padding_bottom.unit",
      "label": "Bottom padding (mobile)",
      "default": 36
    },
    {
      "type": "header",
      "content": "t:sections.all.highlight.header.content"
    },
    {
      "type": "checkbox",
      "id": "enable_highlight",
      "label": "t:sections.all.highlight.enable.label",
      "info": "t:sections.all.highlight.enable.info",
      "default": false
    },
    {
      "type": "select",
      "id": "highlight_style",
      "options": [
        {
          "value": "marker",
          "label": "t:sections.all.highlight.style.options__1.label"
        },
        {
          "value": "circle",
          "label": "t:sections.all.highlight.style.options__2.label"
        },
        {
          "value": "underline",
          "label": "t:sections.all.highlight.style.options__3.label"
        },
        {
          "value": "bold-underline",
          "label": "t:sections.all.highlight.style.options__4.label"
        },
        {
          "value": "modern-underline",
          "label": "t:sections.all.highlight.style.options__5.label"
        },
        {
          "value": "sketch-underline",
          "label": "t:sections.all.highlight.style.options__6.label"
        },
        {
          "value": "squiggle",
          "label": "t:sections.all.highlight.style.options__7.label"
        },
        {
          "value": "heavy-squiggle",
          "label": "t:sections.all.highlight.style.options__8.label"
        },
        {
          "value": "solid-color",
          "label": "t:sections.all.highlight.style.options__9.label"
        }
      ],
      "default": "marker",
      "label": "t:sections.all.highlight.style.label"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer", "custom.overlay"]
  }
}
{% endschema %}
